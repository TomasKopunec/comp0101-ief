#!/bin/env python3
import sys
import yaml
import matplotlib.pyplot as plt
import random
from datetime import datetime
import os

import itertools


def generate_combinations(times, locations):
    # Create all combinations of times and locations
    return list(itertools.product(times, locations))

def assign_random_values(combinations):
    # Assign a random value to each combination
    return [(combo, random.randint(1, 20)) for combo in combinations]

def sort_by_value(combo_values):
    # Sort combinations by their assigned value
    return sorted(combo_values, key=lambda x: x[1])

def plot_combinations(combo_values, filename):
    # Unzip the combination values for plotting
    combos, values = zip(*combo_values)

    # Formatting combinations for display
    formatted_combos = [f"{time}\n{location}" for time, location in combos]
    # print(formatted_combos,values)

    plt.figure(figsize=(15, 8))
    plt.bar(formatted_combos, values)
    plt.xticks(rotation=90)  # Rotate labels for better readability
    plt.title('Combinations of Times and Locations with Assigned Values')
    plt.xlabel('Time and Location Combinations')
    plt.ylabel('Carbon Emissions')

    # Save the plot to a file
    plt.tight_layout()  
    # plt.show()# Adjust layout to fit all x labels
    plt.savefig(filename, bbox_inches='tight')
    plt.close()
    #print(f"Diagram saved as {filename}")

current_path = os.getcwd()


# Function to assign random values


# Initialize an empty list to collect lines
input_lines = []

for line in sys.stdin:
    # Collect the lines
    input_lines.append(line)

# Join the collected lines into a single string
yaml_input = ''.join(input_lines)

try:
    # Parse the entire YAML input
    data = yaml.safe_load(yaml_input)[0]
    
    if data is not None:
        # Extract potential_times and potential_locations
        times = data['potential_times']
        locations = data['potential_locations']
# times = ["2023-11-02T10:35:31.820Z", "2023-11-02T10:40:31.820Z"]
# locations = ["Athens", "Spain"]

# Convert times to datetime objects and assign random values
        combinations = generate_combinations(times, locations)
        # print(combinations)


        combo_values = assign_random_values(combinations)
        sorted_combo_values = sort_by_value(combo_values)
        # print(sorted_combo_values)

# Plot and save the diagram
        plot_combinations(sorted_combo_values, "combinations_diagram.png")
        data['diagram'] = current_path + '/combinations_diagram.png'

        print(data)
    else:
        print("No valid YAML input provided.")
except yaml.YAMLError as e:
    print("Error parsing YAML:", e)
